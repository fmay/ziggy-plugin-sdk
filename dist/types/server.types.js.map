{"version":3,"file":"server.types.js","sourceRoot":"","sources":["../../src/types/server.types.ts"],"names":[],"mappings":"AAEA;;GAEG;AACH,MAAM,CAAN,IAAY,4BAGX;AAHD,WAAY,4BAA4B;IACtC,2CAAW,CAAA;IACX,6CAAa,CAAA;AACf,CAAC,EAHW,4BAA4B,KAA5B,4BAA4B,QAGvC;AAED;;GAEG;AACH,MAAM,CAAN,IAAY,8BAOX;AAPD,WAAY,8BAA8B;IACxC,4DAA0B,CAAA;IAC1B,+FAA6D,CAAA;IAC7D,uFAAqD,CAAA;IACrD,2EAAyC,CAAA;IACzC,mEAAiC,CAAA;IACjC,6CAAW,CAAA;AACb,CAAC,EAPW,8BAA8B,KAA9B,8BAA8B,QAOzC;AAED;;GAEG;AACH,MAAM,CAAN,IAAY,wBAIX;AAJD,WAAY,wBAAwB;IAClC,qCAAS,CAAA;IACT,2CAAe,CAAA;IACf,qDAAyB,CAAA;AAC3B,CAAC,EAJW,wBAAwB,KAAxB,wBAAwB,QAInC","sourcesContent":["import { IFlowBlock } from './client.types.js'\n\n/**\n * Execution environment mode\n */\nexport enum ExecutionEnvironmentModeEnum {\n  DEV = 'DEV',\n  PROD = 'PROD',\n}\n\n/**\n * Execution history logging level\n */\nexport enum IFlowExecutionHistoryLevelEnum {\n  UseDefault = 'USE_DEFAULT',\n  TimeLimitedErroredWithData = 'TIME_LIMITED_ERRORED_WITH_DATA',\n  TimeLimitedAllWithData = 'TIME_LIMITED_ALL_WITH_DATA',\n  ErroredFullWithData = 'ERRORED_WITH_DATA',\n  ErroredNoData = 'ERRORED_NO_DATA',\n  All = 'ALL',\n}\n\n/**\n * Block execution status\n */\nexport enum BlockExecutionStatusEnum {\n  OK = 'OK',\n  ERROR = 'ERROR',\n  TERMINATED = 'TERMINATED',\n}\n\n/**\n * Flow edge data structure\n */\nexport interface IFlowEdgeData {\n  /** The actual data payload (primary data field) */\n  payload?: any\n\n  /** Edge data payload (legacy field) */\n  data?: any\n\n  /** Batch processing information */\n  batchItems?: BatchStackItem[]\n\n  /** Edge label */\n  label?: string\n\n  /** Error message if edge data failed to process */\n  edgeDataErrorMsg?: string\n}\n\n/**\n * Flow edge structure\n */\nexport interface IFlowEdge {\n  /** Edge ID */\n  id: string\n\n  /** Source block ID */\n  source: string\n\n  /** Target block ID */\n  target: string\n\n  /** Source handle ID */\n  sourceHandle?: string\n\n  /** Target handle ID */\n  targetHandle?: string\n\n  /** Edge data */\n  data?: IFlowEdgeData\n}\n\n/**\n * Batch processing stack item\n */\nexport interface BatchStackItem {\n  /** Current iteration count */\n  iterations: number\n\n  /** Current offset */\n  offset: number\n\n  /** Block that initiated the batch */\n  originatorBlock: IFlowBlock\n\n  /** Block that ends the batch */\n  endBlock?: IFlowBlock\n\n  /** Paging token for paginated data sources */\n  paging?: string\n\n  /** Set of edges encountered during batch processing */\n  encounteredEdges?: Set<any>\n\n  /** Flag indicating no more data is available */\n  noMoreData: boolean\n\n  /** Flag indicating batch has been terminated */\n  batchTerminated: boolean\n\n  /** Size of the current batch */\n  batchSize: number\n\n  /** Current index within the batch */\n  index: number\n\n  /** Optional function to close streams (e.g., database cursors) */\n  closeStreamFn?: Function\n\n  /** Additional batch-specific data */\n  extraData?: object\n\n  /** Timestamp of last execution in milliseconds */\n  lastExecutionTime?: number\n}\n\n/**\n * Batch processing stack properties (full server-side version)\n * This is the complete type returned by getBatchStackItem and used by server implementations\n */\nexport interface BatchStackProps {\n  /** Block that initiated the batch */\n  originatorBlock: IFlowBlock\n\n  /** Block that ends the batch (null if not yet determined) */\n  endBlock: IFlowBlock | null\n\n  /** Current offset in the batch processing */\n  offset: number\n\n  /** Paging token for paginated data sources */\n  paging: string\n\n  /** Current iteration count */\n  iterations: number\n\n  /** Set of edges encountered during batch processing */\n  encounteredEdges: Set<any>\n\n  /** Flag indicating no more data is available */\n  noMoreData: boolean\n\n  /** Flag indicating batch has been terminated */\n  batchTerminated: boolean\n\n  /** Size of the current batch */\n  batchSize: number\n\n  /** Current index within the batch */\n  index: number\n\n  /** Optional function to close streams (e.g., database cursors) */\n  closeStreamFn?: Function\n\n  /** Additional batch-specific data */\n  extraData?: object\n\n  /** Timestamp of last execution in milliseconds */\n  lastExecutionTime?: number\n}\n\n/**\n * Fatal error object\n */\nexport interface FatalError {\n  /** Whether a fatal error occurred */\n  isFatalError: boolean\n\n  /** Error message */\n  msg: string\n\n  /** Block ID where error occurred */\n  blockId?: string\n}\n\n/**\n * Timeout configuration\n */\nexport interface TimeoutObject {\n  /** Whether execution timed out */\n  isTimeout: boolean\n\n  /** Timeout duration in ms */\n  timeout: number\n}\n\n/**\n * UI log message\n */\nexport interface UILogMsg {\n  /** Log level */\n  level: string\n\n  /** Log message */\n  message: string\n\n  /** Timestamp */\n  timestamp: Date\n\n  /** Block ID */\n  blockId?: string\n}\n\n/**\n * Main execution props passed to every block's execute function\n */\nexport interface BlockExecutionProps {\n  /** Execution counter */\n  executionCounter: number\n\n  /** Unique execution UUID */\n  executionUuid: string\n\n  /** External execution ID (optional) */\n  externalExecutionId?: string\n\n  /** Whether console logging is enabled */\n  clogging: boolean\n\n  /** Flow model being executed */\n  flow: any\n\n  /** Execution environment (DEV/PROD) */\n  environmentMode: ExecutionEnvironmentModeEnum\n\n  /** Stack of blocks to execute */\n  blockStack: IFlowBlock[]\n\n  /** Available data structures */\n  structures: any[]\n\n  /** Error object for fatal errors */\n  errorObject: FatalError\n\n  /** Timeout configuration */\n  timeoutObject: TimeoutObject\n\n  /** Whether execution was killed */\n  isKilled: boolean\n\n  /** Response data from execution */\n  responseData: any\n\n  /** Whether debug mode is enabled */\n  isDebug: boolean\n\n  /** Whether step mode is enabled */\n  isStep: boolean\n\n  /** Block ID to pause at (debug) */\n  pauseAtBlockId?: string\n\n  /** Whether this is a test execution */\n  isTest: boolean\n\n  /** Execution history logging level */\n  executionHistoryLevel: IFlowExecutionHistoryLevelEnum\n\n  /** Marshaller service instance */\n  marshallerSvc: any\n\n  /** Block registry service instance (for plugin blocks) */\n  blockRegistry?: any\n\n  /**\n   * Log execution time for a block\n   * @param props - Execution props\n   * @param block - Block being executed\n   * @param inEdgeData - Input edge data\n   * @param outEdges - Output edges\n   * @param time - Execution time in ms\n   * @param isRawInputData - Whether input is raw data\n   */\n  logTime: (\n    props: BlockExecutionProps,\n    block: IFlowBlock,\n    inEdgeData: IFlowEdgeData | IFlowEdgeData[] | any[][],\n    outEdges: IFlowEdge | IFlowEdge[],\n    time: number,\n    isRawInputData?: boolean\n  ) => void\n\n  /** The block currently being executed */\n  blockToExecute?: IFlowBlock\n\n  /**\n   * Remove a block from the execution stack\n   * @param id - Block ID to remove\n   * @param stack - The block stack\n   */\n  stackRemove?: (id: string, stack: IFlowBlock[]) => void\n\n  /**\n   * Add a block to the execution stack\n   * @param block - Block to add\n   * @param stack - The block stack\n   */\n  stackAdd?: (block: IFlowBlock, stack: IFlowBlock[]) => void\n\n  /** UI log messages */\n  uiLogMessages: UILogMsg[]\n\n  /** Whether to send socket messages */\n  sendSocketMessages: boolean\n\n  /** Console messages */\n  consoleMessages: any[]\n\n  /** Batch processing stack */\n  batchStack: BatchStackItem[]\n\n  /** Current batch index */\n  batchIndex: number | null\n\n  /** Flow variables storage */\n  variables: Record<string, any>\n\n  /** Execution key for tracking */\n  executionKey?: string\n\n  /** Socket ID for real-time updates */\n  socketId?: string\n\n  /** JWT token for authentication */\n  jwtToken?: string\n\n  /** Auth provider */\n  provider?: string\n\n  /** User ID */\n  userId?: string\n\n  /** Tenant ID for multi-tenancy */\n  tenantId?: string\n\n  /** Whether execution should terminate */\n  terminate: boolean\n\n  /** Timeout timer handle */\n  timeoutTimer?: NodeJS.Timeout | null\n\n  /** Flow debug instance */\n  flowDebug: any\n\n  /** Job group identifier */\n  jobGroup?: string\n\n  // ============================================================\n  // Helper Functions (available on props root for easy access)\n  // ============================================================\n\n  /**\n   * Get input edge data for a specific block and input index\n   * @param block - The block to get input data for\n   * @param inputIndex - The input handle index (default: 0)\n   * @returns The edge data if found, undefined otherwise\n   */\n  getInputEdgeData: (block: IFlowBlock, inputIndex?: number) => IFlowEdgeData | undefined\n\n  /**\n   * Assign data to outgoing edges and add next blocks to the execution stack\n   * @param block - The current block\n   * @param edgeIndex - The output handle index\n   * @param inputEdgeData - The input edge data (or null if no input)\n   * @param outputEdgeData - The data to send to the output edge(s)\n   * @param batchItem - Optional batch item for batch processing\n   * @returns Array of edges that were processed\n   */\n  outgoingEdgeAssignment: (\n    block: IFlowBlock,\n    edgeIndex: number,\n    inputEdgeData: IFlowEdgeData | null,\n    outputEdgeData: any,\n    batchItem?: any\n  ) => any[]\n\n  /**\n   * Formulate a fatal error that will stop flow execution\n   * @param block - The block where the error occurred\n   * @param message - The error message\n   */\n  formulateFatalError: (block: IFlowBlock, message: string) => void\n\n  /**\n   * Log a message to the console and execution logs\n   * @param block - The block logging the message\n   * @param message - The message to log\n   * @param level - The log level (default: 'info')\n   */\n  logMessage: (block: IFlowBlock, message: string, level?: 'info' | 'warn' | 'error' | 'debug') => void\n\n  /**\n   * Validate that a config object contains required properties\n   * @param config - The configuration object to validate\n   * @param requiredProps - Array of required property names\n   * @throws Error if any required properties are missing\n   */\n  validateConfig: (config: any, requiredProps: string[]) => void\n\n  /**\n   * Safely wait for input edge data to arrive at a specific input handle\n   * Handles flow termination gracefully by returning null if terminated\n   * @param blockId - The block ID to wait for data on\n   * @param handleId - The input handle ID (e.g., 'i0', 'i1')\n   * @returns The edge data if received, null if flow terminated\n   */\n  safeWaitForInputEdgeData: (blockId: string, handleId: string) => Promise<IFlowEdgeData | null>\n\n  /**\n   * Safely wait for all input edge data to arrive at a block\n   * Waits until all incoming edges have data, then returns them sorted by handle (i0, i1, i2, etc.)\n   * Handles flow termination gracefully by returning null if terminated\n   * @param block - The block to wait for all input data on\n   * @returns Array of edge data sorted by input handle, or null if flow terminated\n   */\n  safeWaitForAllInputEdgeData: (block: IFlowBlock) => Promise<IFlowEdgeData[] | null>\n\n  /**\n   * Get or create a batch stack item for the current block\n   * Used by blocks that initiate batch processing (Iterator, Loop, etc.)\n   * @param block - The block initiating the batch\n   * @returns The batch stack properties with iteration state\n   */\n  getBatchStackItem: (block: IFlowBlock) => BatchStackProps\n\n  /**\n   * Terminate a batch processing loop\n   * Removes batch from stack, closes streams, and routes to next blocks\n   * @param batchItem - The batch stack properties to terminate\n   */\n  terminateBatch: (batchItem: BatchStackProps) => void\n\n  /**\n   * Checks if a batch should be terminated based on iteration limits and data availability\n   * Automatically terminates the batch if conditions are met\n   * @param batchItem - The batch stack item to check\n   * @param maxIterations - Maximum number of iterations allowed (0 or undefined means no limit)\n   * @returns true if batch was terminated, false otherwise\n   */\n  shouldTerminateBatchHelper: (batchItem: BatchStackProps, maxIterations: number) => boolean\n\n  /**\n   * Log block execution time and data metrics\n   * Already defined above but included here for completeness - this is a duplicate reference\n   */\n  // logTime is already defined at line 198\n}\n\n/**\n * Block execution result\n */\nexport interface BlockExecutionResult {\n  status: BlockExecutionStatusEnum\n  error: Error | null\n}\n"]}